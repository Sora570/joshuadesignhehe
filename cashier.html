<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cashier POS — Kape Timplado's (Responsive)</title>

  <!-- Icons & Fonts -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brown:#7f5539;
      --brown-dark:#6d4329;
      --beige:#faf6f3;
      --accent:#3D2B1F;
      --bg:#f7f4f2;
      --card:#fff;
      --glass: rgba(255,255,255,0.7);
      --success: #28a745;
      --danger: #dc3545;
      --muted: #3D2B1F;
      --radius: 12px;
      --max-width: 1300px;
      --gap: 14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Fredoka',system-ui,Arial;background:linear-gradient(180deg,#fbf9f7,#f0e9e5);color:#2b2020}
    a{color:inherit;text-decoration:none}

    /* Container */
    .app {
      max-width: var(--max-width);
      margin: 18px auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,246,243,0.9));
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(35,25,20,0.08);
      overflow: hidden;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 0;
      min-height: 80vh;
    }

    /* Sidebar / Navigation */
    .sidebar {
      background: linear-gradient(180deg,var(--brown) 0%, #6a3f2e 100%);
      color: #fff;
      padding: 18px 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 320px;
    }
    .brand {
      display:flex;align-items:center;gap:10px;padding:6px 12px;border-radius:10px;background:rgba(255,255,255,0.06)
    }
    .brand img{width:42px;height:42px;border-radius:6px;object-fit:cover;box-shadow:0 2px 6px rgba(0,0,0,0.15)}
    .brand .title{font-size:1.1rem;font-weight:600}
    .nav-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer;color:#fff;transition:background .15s}
    .nav-item ion-icon{font-size:20px}
    .nav-item.active, .nav-item:hover{background:rgba(255,255,255,0.07)}
    .nav-item .label{font-weight:600}
    .sidebar .userbox{margin-top:auto;padding:10px;border-radius:10px;background:rgba(0,0,0,0.06);display:flex;align-items:center;gap:12px}
    .userbox img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.12)}
    .userbox .name{font-size:0.95rem}
    .signout{margin-top:8px;background:rgba(255,255,255,0.08);border:none;padding:8px;border-radius:8px;color:#fff;cursor:pointer}

    /* Main */
    .main {
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: calc(100vh - 100px);
    }

    .topbar {
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .topbar .left {
      display:flex;align-items:center;gap:8px;
    }
    .topbar .toggle {display:none;padding:8px;border-radius:10px;background:var(--card);cursor:pointer;box-shadow:0 2px 6px rgba(20,10,8,0.05)}
    .search {
      display:flex;align-items:center;gap:8px;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 2px 6px rgba(20,10,8,0.03)
    }
    .search input{border:0;outline:none;font-size:14px;background:transparent;padding:6px}

    .category-select {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.06);
      background: var(--card);
      font-size: 14px;
      color: var(--muted);
    }

    .cart-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 10px;
      background: var(--card);
      border: 1px solid rgba(0,0,0,0.06);
      cursor: pointer;
      font-size: 14px;
      color: var(--brown);
      transition: background 0.15s;
    }

    .cart-btn:hover {
      background: var(--beige);
    }

    .cart-btn ion-icon {
      font-size: 18px;
    }

    .badge {
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      min-width: 20px;
    }

    /* POS layout (Products + Cart) */
    .pos {
      display: flex;
      flex-direction: row;
      height: calc(100vh - 140px);
      gap: 18px;
    }

    /* Menu section */
    .menu {
      background:var(--card);
      padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(35,25,20,0.04);
      display:flex;flex-direction:column;gap:12px; flex: 1; overflow: hidden;
    }

    .products-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:12px;
      overflow-y:auto;
      height: calc(100% - 50px);
      padding-bottom:6px;
    }
    .product-card {
      background:linear-gradient(180deg,var(--glass),var(--card));
      border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;align-items:stretch;
      cursor:pointer;transition:transform .12s, box-shadow .12s;
      aspect-ratio: 1;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .product-card:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(30,15,10,0.06)}
    .product-meta{display:flex;flex-direction:column;gap:4px;}
    .product-meta .name{font-weight:600;font-size:15px;color:var(--brown-dark); text-align:center; word-break: break-word;}
    .product-meta .category{font-size:12px;color:var(--muted); text-align:center; word-break: break-word; margin-bottom: 8px;}
    .product-meta .sizes{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .size-btn{
      padding:6px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:var(--beige);font-size:12px;cursor:pointer;font-weight:500
    }

    /* Cart */
    .cart {
      background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(35,25,20,0.04);display:flex;flex-direction:column; width: 320px; flex-shrink: 0; overflow-y: auto;
    }
    .cart .cart-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .cart-items{margin-top:10px;display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:52vh;padding-right:6px}
    .cart-items .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 16px;
      opacity: 0.7;
    }
    .cart-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(180deg, #fff,#fbf6f4)}
    .ci-info{flex:1;display:flex;flex-direction:column;gap:4px}
    .ci-controls{display:flex;align-items:center;gap:6px}
    .qty-btn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
    .remove-btn{background:transparent;border:0;color:var(--danger);cursor:pointer;font-size:14px}

    .cart-footer{margin-top:auto;padding-top:10px;border-top:1px dashed rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:8px}
    .totals{display:flex;flex-direction:column;gap:6px}
    .totals .row{display:flex;justify-content:space-between;font-weight:600}
    .checkout-btn{margin-top:6px;padding:12px;border-radius:10px;border:0;background:var(--brown);color:#fff;font-weight:700;cursor:pointer}

    /* Orders & Closeout sections (simple) */
    .section-card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(35,25,20,0.04); min-height: calc(100vh - 200px); display: flex; flex-direction: column;}
    .orders-table{width:100%;border-collapse:collapse}
    .orders-table th, .orders-table td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.05);text-align:left;font-size:13px}
    .orders-actions button{margin-right:8px;padding:6px 10px;border-radius:8px;border:0;cursor:pointer}

    /* Checkout modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);padding:18px;border-radius:12px;max-width:520px;width:100%;box-shadow:0 20px 60px rgba(10,10,10,0.2)}
    .modal h3{margin-top:0}

    /* Responsiveness */
    @media (max-width:1200px){
      .products-grid{grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))}
      .app{grid-template-columns: 220px 1fr}
    }
    @media (max-width:880px){
      .app{grid-template-columns: 1fr}
      .sidebar{flex-direction:row;gap:8px;align-items:center;padding:10px;overflow:auto;min-height:64px}
      .sidebar .brand{display:none}
      .topbar .toggle{display:block}
      .pos{flex-direction: column; height: auto; gap:10px;}
      .products-grid{grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); height: 60vh;}
      .cart { width: auto; order: 2; }
    }
    @media (max-width:800px){
      .products-grid{grid-template-columns: 1fr;}
      .product-image{height:100px;}
      .size-btn{font-size:11px; padding:5px 10px;}
    }
    @media (max-width:520px){
      .products-grid{grid-template-columns: repeat(1, 1fr)}
      .product-image{width:70px;max-height:60px}
      .cart-items{max-height:38vh}
    }

    /* small helpers */
    .muted{color:var(--muted);font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}
    .small{font-size:13px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.04)}

    /* Toast notification */
    .toast{position:fixed;top:20px;right:20px;background:var(--danger);color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;opacity:0;transform:translateY(-20px);transition:opacity 0.3s, transform 0.3s;max-width:300px;word-wrap:break-word}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--success)}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <img src="assest/image/logo.png" alt="logo" onerror="this.src='assest/image/no-image.png'">
        <div>
          <div style="font-size:1rem;font-weight:700">Kape Timplado's</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.85)">Cashier</div>
        </div>
      </div>

      <nav class="nav-list" id="nav">
        <div class="nav-item active" data-section="ProductsForm"><ion-icon name="fast-food-outline"></ion-icon><span class="label">Products</span></div>
        <div class="nav-item" data-section="OrdersForm"><ion-icon name="receipt-outline"></ion-icon><span class="label">Orders</span></div>
        <div class="nav-item" data-section="CloseoutForm"><ion-icon name="calculator-outline"></ion-icon><span class="label">Close-Out</span></div>
        <div class="nav-item" id="signOutBtn"><ion-icon name="log-out-outline"></ion-icon><span class="label">Sign Out</span></div>
      </nav>

      <div class="userbox">
        <img src="assest/image/User Image.jpg" alt="user" onerror="this.src='assest/image/no-image.png'">
        <div>
          <div class="name">Hello, Cashier</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="left">
          <button class="toggle" id="sidebarToggle"><ion-icon name="menu-outline"></ion-icon></button>
          <h2 style="margin:0">Point of Sale & Orders</h2>
        </div>

        <div style="display:flex;align-items:center;gap:10px">
          <div class="search">
            <ion-icon name="search-outline"></ion-icon>
            <input id="globalSearch" placeholder="Search products..." />
          </div>
          <select id="categoryFilter" class="category-select">
            <option value="">All Categories</option>
          </select>
          <button id="cartBtn" class="cart-btn">
            <ion-icon name="cart-outline"></ion-icon>
            Cart <span id="cartBadge" class="badge">0</span>
          </button>
        </div>
      </div>

      <!-- Sections -->
      <section id="ProductsForm" class="section-card" style="display:block">
        <div class="pos">
          <!-- Menu -->
          <div class="menu">

            <div class="products-grid" id="productsGrid" aria-live="polite">
              <!-- product cards inserted here -->
            </div>
          </div>

          <!-- Cart -->
          <aside class="cart">
            <div class="cart-header">
              <h3 style="margin:0">Cart</h3>
              <div class="muted small">₱ currency</div>
            </div>

            <div class="cart-items" id="cartItems">
              <div class="muted empty-state">Cart is empty</div>
            </div>

            <div class="cart-footer">
              <div class="totals">
                <div class="row" style="font-size:18px"><strong>Total</strong><strong id="total">₱0.00</strong></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <button class="checkout-btn" id="checkoutBtn">Checkout</button>
                <button class="btn-secondary pill" id="clearCartBtn">Clear</button>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Orders -->
      <section id="OrdersForm" class="section-card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">Orders</h3>
          <div style="display:flex;gap:8px">
            <input id="orderSearch" placeholder="Search orders..." style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
          </div>
        </div>

        <div style="flex: 1; overflow: auto;">
          <table class="orders-table" aria-live="polite" style="width: 100%;">
            <thead>
              <tr><th>ID</th><th>Items</th><th>Total</th><th>Status</th><th>Reference Number</th></tr>
            </thead>
            <tbody id="ordersTableBody">
              <!-- orders -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Closeout -->
      <section id="CloseoutForm" class="section-card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Close-Out / End of Shift</h3>
          <div class="muted">Summary of current session</div>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px">
            <div style="background:var(--card);padding:12px;border-radius:10px">
              <div class="muted small">Total Orders</div><div id="summaryOrders" style="font-weight:700">0</div>
            </div>
            <div style="background:var(--card);padding:12px;border-radius:10px">
              <div class="muted small">Gross Sales</div><div id="summaryGross" style="font-weight:700">₱0.00</div>
            </div>
            <div style="background:var(--card);padding:12px;border-radius:10px">
              <div class="muted small">Discounts</div><div id="summaryDiscounts" style="font-weight:700">₱0.00</div>
            </div>
            <div style="background:var(--card);padding:12px;border-radius:10px">
              <div class="muted small">Net Sales</div><div id="summaryNet" style="font-weight:700">₱0.00</div>
            </div>
          </div>


        </div>
      </section>
    </main>
  </div>

  <!-- Modal placeholder -->
  <div id="modalRoot"></div>

  <script>
    /* ----------------------
       Simple responsive POS JS
       - loads products (tries backend else uses mock)
       - search, filter
       - cart functionality (qty, remove)
       - checkout modal (simulate)
       - mock orders & closeout summary
    ----------------------- */

    (function(){
      // State
      let products = [];
      let categories = [];
      let cart = [];
      let orders = [];
      let useMock = false;

      // DOM refs
      const productsGrid = document.getElementById('productsGrid');
      const categoryFilter = document.getElementById('categoryFilter');
      const globalSearch = document.getElementById('globalSearch');
      const cartItemsEl = document.getElementById('cartItems');
      const totalEl = document.getElementById('total');
      const checkoutBtn = document.getElementById('checkoutBtn');
      const clearCartBtn = document.getElementById('clearCartBtn');
      const cartBtn = document.getElementById('cartBtn');
      const cartBadge = document.getElementById('cartBadge');

      const navItems = document.querySelectorAll('.nav-item');
      const sections = { ProductsForm: document.getElementById('ProductsForm'), OrdersForm: document.getElementById('OrdersForm'), CloseoutForm: document.getElementById('CloseoutForm') };

      // Mock product data (used when backend not available)
      const mockProducts = [
        { productID:1, productName:'Espresso', categoryName:'Coffee', categoryID:1, image_url:'https://images.unsplash.com/photo-1511920170033-f8396924c348?w=800&q=60', sizes:[{sizeID:1,sizeName:'Single',price:60},{sizeID:2,sizeName:'Double',price:80}], isActive:1 },
        { productID:2, productName:'Cappuccino', categoryName:'Coffee', categoryID:1, image_url:'https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=800&q=60', sizes:[{sizeID:3,sizeName:'Small',price:90},{sizeID:4,sizeName:'Large',price:120}], isActive:1 },
        { productID:3, productName:'Iced Latte', categoryName:'Cold Drinks', categoryID:2, image_url:'https://images.unsplash.com/photo-1563805042-7684c019e1cb?w=800&q=60', sizes:[{sizeID:5,sizeName:'Regular',price:100}], isActive:1 },
        { productID:4, productName:'Brown Sugar Latte', categoryName:'Specialty', categoryID:3, image_url:'https://images.unsplash.com/photo-1541167760496-1628856ab772?w=800&q=60', sizes:[{sizeID:6,sizeName:'Regular',price:130}], isActive:1 },
        { productID:5, productName:'Mocha', categoryName:'Coffee', categoryID:1, image_url:'https://images.unsplash.com/photo-1507668077129-56e32842fceb?w=800&q=60', sizes:[{sizeID:7,sizeName:'Small',price:95},{sizeID:8,sizeName:'Large',price:140}], isActive:1 },
        { productID:6, productName:'Mango Smoothie', categoryName:'Fruit Drinks', categoryID:4, image_url:'https://images.unsplash.com/photo-1572448862527-68f2b52d1d11?w=800&q=60', sizes:[{sizeID:9,sizeName:'Regular',price:110}], isActive:1 }
      ];

      // Try to fetch products from backend, else fallback
      async function fetchProducts(){
        if (!useMock){
          try {
            const res = await fetch('db/products_getAll.php', {cache:'no-store'});
            if (!res.ok) throw new Error('Network response not ok');
            const data = await res.json();
            // Expect data.products or array
            products = data.products || data;
            if (!Array.isArray(products) || products.length === 0) throw new Error('No products');
            buildCategories();
            renderProducts();
            return;
          } catch (err) {
            console.warn('Backend products fetch failed, switching to mock', err);
            useMock = true;
          }
        }

        // Use mock data
        products = mockProducts.slice();
        buildCategories();
        renderProducts();
      }

      function buildCategories(){
        const unique = {};
        categories = [];
        products.forEach(p => {
          if (!unique[p.categoryID]) {
            unique[p.categoryID] = p.categoryName || 'Uncategorized';
            categories.push({categoryID: p.categoryID, categoryName: p.categoryName || 'Uncategorized'});
          }
        });
        updateCategorySelect();
      }

      function updateCategorySelect(){
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.categoryID;
          opt.textContent = c.categoryName;
          categoryFilter.appendChild(opt);
        });
      }

      // Render products grid (filtered)
      function renderProducts(filtered){
        const list = filtered || products;
        productsGrid.innerHTML = '';
        if (!list || list.length === 0){
          productsGrid.innerHTML = '<div class="muted empty-state">No products found</div>';
          return;
        }
        list.forEach(p => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.setAttribute('data-id', p.productID);
          card.innerHTML = `
            <div class="product-meta">
              <div class="name">${escapeHtml(p.productName)}</div>
              <div class="category muted small">${escapeHtml(p.categoryName || '')}</div>
              <div class="sizes"></div>
            </div>
          `;
          const sizesDiv = card.querySelector('.sizes');
          if (p.sizes && p.sizes.length){
            p.sizes.forEach(s => {
              const b = document.createElement('button');
              b.className = 'size-btn';
              b.textContent = `${s.sizeName}oz — ₱${formatNumber(s.price)}`;
              b.addEventListener('click', (e) => {
                e.stopPropagation();
                addToCart(p, s);
              });
              sizesDiv.appendChild(b);
            });
          } else {
            const b = document.createElement('button');
            b.className = 'size-btn';
            b.textContent = `Add — ₱0.00`;
            b.addEventListener('click', (e) => {
              e.stopPropagation();
              addToCart(p, null);
            });
            sizesDiv.appendChild(b);
          }

          productsGrid.appendChild(card);
        });
      }

      // Utility: escape html
      function escapeHtml(s){ return (''+s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[c]); }

      // Formatting
      function formatNumber(n){ return Number(n).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2}); }
      function currency(n){ return '₱' + formatNumber(n); }

      // Cart logic
      function addToCart(product, size){
        // If product has sizes, size provided; else default price 0
        const item = {
          cartID: Date.now() + Math.floor(Math.random()*1000),
          productID: product.productID,
          name: product.productName,
          sizeID: size ? size.sizeID : null,
          sizeName: size ? size.sizeName : '',
          price: size ? Number(size.price) : (product.price ? Number(product.price) : 0),
          qty: 1,
          image: product.image_url || ''
        };
        // If same product+size exists -> increment qty
        const existing = cart.find(c => c.productID === item.productID && c.sizeID === item.sizeID);
        if (existing){
          existing.qty += 1;
        } else {
          cart.push(item);
        }
        renderCart();
      }

      function renderCart(){
        cartItemsEl.innerHTML = '';
        if (cart.length === 0){
          cartItemsEl.innerHTML = '<div class="muted empty-state">Cart is empty</div>';
          updateTotals();
          if (cartBadge) cartBadge.textContent = '0';
          return;
        }
        cart.forEach(ci => {
          const el = document.createElement('div');
          el.className = 'cart-item';
          el.innerHTML = `
            <div class="ci-info" style="flex:1;">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:600">${escapeHtml(ci.name)}</div>
                <div style="font-size:13px;color:var(--muted)">${ci.sizeName ? ci.sizeName + 'oz' : ''}</div>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
                <div class="ci-controls">
                  <button class="qty-btn" data-action="decrease">-</button>
                  <input type="number" class="qty-input" value="${ci.qty}" min="1" style="padding:6px 8px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.04);width:60px;text-align:center;">
                  <button class="qty-btn" data-action="increase">+</button>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700">${currency(ci.price * ci.qty)}</div>
                  <button class="remove-btn small" data-action="remove">Remove</button>
                </div>
              </div>
            </div>
          `;
          // Buttons
          el.querySelector('[data-action=increase]').addEventListener('click', ()=> { ci.qty++; renderCart(); });
          el.querySelector('[data-action=decrease]').addEventListener('click', ()=> { if (ci.qty>1) ci.qty--; else removeFromCart(ci.cartID); renderCart(); });
          el.querySelector('[data-action=remove]').addEventListener('click', ()=> { removeFromCart(ci.cartID); });
          // Input event
          const qtyInput = el.querySelector('.qty-input');
          qtyInput.addEventListener('input', (e)=> {
            const val = parseInt(e.target.value);
            if (isNaN(val) || val < 1) {
              e.target.value = ci.qty; // revert
            } else {
              ci.qty = val;
              renderCart();
            }
          });
          cartItemsEl.appendChild(el);
        });
        updateTotals();
        if (cartBadge) cartBadge.textContent = cart.length;
      }

      function removeFromCart(cartID){
        cart = cart.filter(c=> c.cartID !== cartID);
        renderCart();
      }

      function clearCart(){
        cart = [];
        renderCart();
      }

      function updateTotals(){
        const subtotal = cart.reduce((s,i)=> s + (i.price * i.qty), 0);
        const discount = 0; // placeholder for discount logic
        const tax = 0; // tax removed
        const total = subtotal - discount + tax;

        totalEl.textContent = currency(total);

        // update closeout summary small (for demo)
        document.getElementById('summaryOrders').textContent = orders.length;
        document.getElementById('summaryGross').textContent = currency(orders.reduce((s,o)=>s+o.total,0));
        document.getElementById('summaryDiscounts').textContent = currency(0);
        document.getElementById('summaryNet').textContent = currency(orders.reduce((s,o)=>s+o.total,0));
      }

      // Toast notification
      function showToast(message, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'success' : ''}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }

      // Inventory check
      async function checkInventory(){
        try {
          const res = await fetch('db/inventory_get.php');
          if (!res.ok) throw new Error('Failed to fetch inventory');
          const inventory = await res.json();
          const sizeGroups = {};
          cart.forEach(item => {
            if (item.sizeID) {
              if (!sizeGroups[item.sizeID]) sizeGroups[item.sizeID] = { qty: 0, sizeName: item.sizeName };
              sizeGroups[item.sizeID].qty += item.qty;
            }
          });
          for (const sizeID in sizeGroups) {
            const group = sizeGroups[sizeID];
          const cupItem = inventory.find(i => i.InventoryName === 'Cup' && i.Size === group.sizeName && i.Unit === 'Ounce');
            if (cupItem && cupItem['Current Stock'] < group.qty) {
              showToast(`Insufficient stock for ${group.sizeName}oz cups: need ${group.qty}, have ${cupItem['Current Stock']}`);
              return false;
            }
          }
          return true;
        } catch (err) {
          console.error('Inventory check failed:', err);
          showToast('Unable to check inventory. Please try again.');
          return false;
        }
      }

      // Checkout
      async function openCheckout(){
        if (cart.length === 0) { alert('Cart is empty'); return; }
        const hasStock = await checkInventory();
        if (!hasStock) return;
        const subtotal = cart.reduce((s,i)=> s + (i.price * i.qty), 0);
        const tax = 0; // tax removed
        const total = subtotal + tax;
        const modal = createModal(`
          <h3>Checkout</h3>
          <div style="margin-top:8px">
            <div class="small muted">Items: ${cart.length}</div>
            <div style="display:flex;justify-content:space-between;font-size:18px;margin-top:6px"><strong>Total</strong><div>${currency(total)}</div></div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button id="payCash" class="pill">Pay Cash</button>
            <button id="payGcash" class="pill">Pay Gcash</button>
            <button id="cancelModal" class="pill">Cancel</button>
          </div>
        `);

        document.getElementById('cancelModal').addEventListener('click', ()=> modal.close());
        document.getElementById('payCash').addEventListener('click', ()=> processPayment('Cash', total, modal));
        document.getElementById('payGcash').addEventListener('click', ()=> processPayment('Gcash', total, modal));
      }

      async function processPayment(method, totalAmount, modal){
        try {
          // Validate cart data before sending
          if (!cart || cart.length === 0) {
            throw new Error('Cart is empty');
          }

          // Prepare cart items with validation
          const cartItems = cart.map(item => {
            if (!item.productID || !item.price || !item.qty) {
              throw new Error(`Invalid cart item: ${JSON.stringify(item)}`);
            }
            return {
              productID: item.productID,
              sizeID: item.sizeID || null,
              quantity: item.qty,
              unitPrice: item.price,
              totalPrice: item.price * item.qty,
              addons: []
            };
          });

          console.log('Sending cart data:', cartItems);

          const formData = new FormData();
          formData.append('cartItems', JSON.stringify(cartItems));
          formData.append('paymentMethod', method);
          formData.append('cashReceived', totalAmount.toString());
          formData.append('discountType', 'none');
          formData.append('discountPercentage', '0');

          console.log('Sending checkout request...');

          const res = await fetch('db/checkout_process.php', {
            method: 'POST',
            body: formData
          });

          console.log('Response status:', res.status);
          console.log('Response headers:', res.headers);

          if (!res.ok) {
            const errorText = await res.text();
            console.error('HTTP Error:', res.status, errorText);
            throw new Error(`HTTP ${res.status}: ${errorText}`);
          }

          const data = await res.json();
          console.log('Response data:', data);

          if (data.status === 'success') {
            showToast('Order completed successfully!', 'success');
            modal.close();
            clearCart();
            renderOrders();
          } else {
            console.error('Backend error:', data.message);
            showToast(data.message || 'Checkout failed');
          }
        } catch (err) {
          console.error('Checkout error details:', err);
          console.error('Error stack:', err.stack);
          showToast(`Checkout failed: ${err.message}`);
        }
      }

      async function loadOrders(){
        try {
          const response = await fetch('db/orders_get.php');
          const data = await response.json();

          if (data.status === 'success') {
            // Combine pending and completed orders
            orders = [...(data.pending || []), ...(data.completed || [])];
            renderOrders();
          } else {
            console.error('Failed to load orders:', data.message);
            showToast('Failed to load orders', 'error');
          }
        } catch (error) {
          console.error('Error loading orders:', error);
          showToast('Error loading orders', 'error');
        }
      }

      function renderOrders(){
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        if (orders.length === 0){
          tbody.innerHTML = '<tr><td colspan="5" class="muted">No orders yet</td></tr>';
          return;
        }
        orders.forEach(o => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(o.orderID || o.id || 'N/A')}</td>
                          <td>${escapeHtml(o.items || 'No items')}</td>
                          <td>${currency(o.totalAmount || o.total || 0)}</td>
                          <td>${escapeHtml(o.status || 'pending')}</td>
                          <td>${escapeHtml(o.orderID || o.id || 'N/A')}</td>`;
          tbody.appendChild(tr);
        });
      }

      // Modal helper
      function createModal(innerHtml){
        const wrapper = document.createElement('div');
        wrapper.className = 'modal-backdrop';
        wrapper.innerHTML = `<div class="modal">${innerHtml}</div>`;
        document.getElementById('modalRoot').appendChild(wrapper);
        wrapper.addEventListener('click', (e)=> { if (e.target === wrapper) close(); });
        function close(){ wrapper.remove(); }
        return { el: wrapper, close };
      }

      // Search and filters
      function applyFilters(){
        const q = (globalSearch.value || '').toLowerCase();
        const cat = categoryFilter.value;
        let filtered = products.filter(p => {
          const matchesQ = p.productName.toLowerCase().includes(q) || (p.categoryName && p.categoryName.toLowerCase().includes(q));
          const matchesCat = !cat || p.categoryID == cat;
          return matchesQ && matchesCat;
        });
        renderProducts(filtered);
      }

      // Global search: switch view to orders if query looks like order id; else filter products
      globalSearch.addEventListener('input', (e)=>{
        const v = (e.target.value || '').trim();
        if (!v) return;
        // If starts with ORD -> switch to orders view and filter table
        if (/^ord/i.test(v)){
          showSection('OrdersForm');
          // filter orders table simple
          const rows = Array.from(document.querySelectorAll('#ordersTableBody tr'));
          rows.forEach(r => {
            const matches = r.innerText.toLowerCase().includes(v.toLowerCase());
            r.style.display = matches ? '' : 'none';
          });
        } else {
          // filter products
          applyFilters();
          showSection('ProductsForm');
        }
      });

      // UI events
      categoryFilter.addEventListener('change', applyFilters);
      clearCartBtn.addEventListener('click', ()=> { if (confirm('Clear cart?')) clearCart(); });
      checkoutBtn.addEventListener('click', openCheckout);
      // Cart button
      cartBtn.addEventListener('click', () => {
        showSection('ProductsForm');
        const cartEl = document.querySelector('.cart');
        if (cartEl) {
          cartEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });

      // Navigation
      navItems.forEach(n => {
        n.addEventListener('click', ()=> {
          navItems.forEach(x=>x.classList.remove('active'));
          n.classList.add('active');
          showSection(n.dataset.section);
        });
      });
      function showSection(id){
        Object.keys(sections).forEach(k => sections[k].style.display = (k===id) ? 'block' : 'none');
      }

      // Sidebar toggle (mobile)
      document.getElementById('sidebarToggle').addEventListener('click', ()=>{
        document.getElementById('sidebar').style.display = document.getElementById('sidebar').style.display === 'none' ? '' : 'none';
      });

      // Sign out functionality
      document.getElementById('signOutBtn').addEventListener('click', ()=> {
        if (confirm('Sign out?')) {
          // Redirect to login page
          window.location.href = 'loginRegister.html';
        }
      });



      // Init
      (function init(){
        // try backend first, fallback to mock data if unavailable
        fetchProducts();
        renderCart();
        loadOrders(); // Load orders from backend instead of using mock data
      })();

      // small helper fallback: attempt to fetch categories endpoint (if backend available)
      async function tryLoadCategories(){
        if (!useMock){
          try{
            const res = await fetch('db/categories_getAll.php');
            if (!res.ok) throw new Error('no cat');
            const data = await res.json();
            if (Array.isArray(data)) { categories = data; updateCategorySelect(); }
          }catch(e){ /* ignore */ }
        }
      }

      // expose some helpers for integration
      window.POS = {
        addToCart: addToCart,
        clearCart: clearCart,
        getCart: ()=> cart,
        setUseMock: (b)=> { useMock = !!b; fetchProducts(); }
      };

    })();
  </script>
</body>
</html>
